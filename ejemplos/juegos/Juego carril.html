<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
<title>Carril del Delf√≠n ‚Äî runner 3 carriles (v2)</title>
<style>
  :root{ --bg:#072a44; --sea:#0e5a92; --text:#e9f6ff; --ui:#1d4b6b; --ui2:#2a6287; --ok:#1bb37a; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;}
  #wrap{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr;gap:6px;padding:6px}
  #top{display:flex;align-items:center;gap:6px;white-space:nowrap;overflow:hidden}
  .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.10);font-weight:700}
  .btn{appearance:none;border:0;border-radius:999px;padding:8px 12px;background:var(--ui);color:var(--text);font-weight:800}
  .btn:active{transform:translateY(1px);background:var(--ui2)}
  .switch{display:flex;align-items:center;gap:6px}
  #stage{position:relative;background:linear-gradient(#0a3d66,#0e5a92);border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.15)}
  #laneWrap{position:absolute;inset:0;display:grid;grid-template-columns:repeat(3,1fr);gap:6px;padding:6px}
  .lane{border-radius:10px;background:rgba(255,255,255,.06);position:relative;overflow:hidden}
  .entity{position:absolute;left:0;top:0;transform:translate(-9999px,-9999px);display:grid;place-items:center;
    width:64px;height:64px;border-radius:12px;font-size:36px;font-weight:900;
    box-shadow:inset 0 0 0 2px rgba(255,255,255,.22), 0 10px 22px rgba(0,0,0,.35);}
  .player{background:#5bd0ff;color:#072a44}
  .good{background:#ff9a3c;color:#072a44} /* Fondo naranja para estrella */
  .bad{background:#ff7a6e;color:#072a44}
  .safe .player{background:#5bd0ff}
  .safe .good{background:#ff9a3c}
  .safe .bad{background:#ff7a6e}
  #modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45)}
  #card{background:#0b304d;border:1px solid rgba(255,255,255,.15);border-radius:16px;padding:18px;max-width:92vw;text-align:center}
</style>
</head>
<body>
<div id="wrap">
  <div id="top">
    <div class="pill">‚è± <b id="time">60</b>s</div>
    <div class="pill">Pts <b id="score">0</b></div>
    <div class="pill">Rec <b id="best">0</b></div>
    <div class="pill">‚≠ê <b id="stars">0</b></div>
    <label class="pill switch"><input id="safe" type="checkbox"/> Seguro</label>
    <button id="btnNew" class="btn">‚Ü∫</button>
  </div>

  <div id="stage">
    <div id="laneWrap">
      <div class="lane" id="lane0"></div>
      <div class="lane" id="lane1"></div>
      <div class="lane" id="lane2"></div>
    </div>
  </div>
</div>

<div id="modal">
  <div id="card">
    <h2>Fin de partida</h2>
    <p>Puntuaci√≥n: <b id="mscore">0</b></p>
    <p>R√©cord: <b id="mbest">0</b></p>
    <p>‚≠ê Ganadas: <b id="mstars">0</b></p>
    <div style="display:flex;gap:10px;justify-content:center;margin-top:10px">
      <button id="again" class="btn">Otra</button>
      <button id="close" class="btn" style="background:var(--ok)">Cerrar</button>
    </div>
  </div>
</div>

<script>
(function(){
  var BEST_KEY="runner2_best"; var STARS_KEY="runner2_stars";
  function getBest(){ var v=localStorage.getItem(BEST_KEY); return v?Number(v):0; }
  function setBest(v){ localStorage.setItem(BEST_KEY,String(v)); }
  function getStars(){ var v=localStorage.getItem(STARS_KEY); return v?Number(v):0; }
  function addStars(n){ var t=getStars()+n; localStorage.setItem(STARS_KEY,String(t)); return t; }

  var stage=document.getElementById('stage');
  var lanes=[document.getElementById('lane0'), document.getElementById('lane1'), document.getElementById('lane2')];
  var safe=document.getElementById('safe');
  var scoreEl=document.getElementById('score');
  var timeEl=document.getElementById('time');
  var bestEl=document.getElementById('best');
  var starsEl=document.getElementById('stars');
  var btnNew=document.getElementById('btnNew');
  var modal=document.getElementById('modal');
  var mscore=document.getElementById('mscore');
  var mbest=document.getElementById('mbest');
  var mstars=document.getElementById('mstars');

  bestEl.textContent=getBest();
  starsEl.textContent=getStars();

  var ICONS = {player:"üê¨", good:"‚≠ê", bad:"ü¶à"};
  var running=false, score=0, timerId=null, timeLeft=60;
  var lane=1, ENTITY_SIZE=64, speed=180;
  var spawnEvery=900, lastSpawn=0;
  var entities=[];
  var player=null, playerY=0;

  function sizeStage(){
    var laneW = lanes[0].getBoundingClientRect().width;
    ENTITY_SIZE = Math.max(40, Math.floor(laneW * 0.76));
  }
  window.addEventListener('resize', sizeStage);

  function makeEntity(type, laneIndex, y){
    var el=document.createElement('div');
    el.className='entity '+type + (safe.checked?" safe":"");
    el.style.width=ENTITY_SIZE+"px"; el.style.height=ENTITY_SIZE+"px";
    el.textContent = safe.checked ? (type==="good"?"G":type==="bad"?"X":"P") : (type==="good"?ICONS.good:type==="bad"?ICONS.bad:ICONS.player);
    lanes[laneIndex].appendChild(el);
    positionEntity(el, laneIndex, y);
    return {el:el, lane:laneIndex, y:y, type:type};
  }

  function positionEntity(el, laneIndex, y){
    var laneRect = lanes[laneIndex].getBoundingClientRect();
    var x = (laneRect.width - ENTITY_SIZE)/2;
    el.style.transform = "translate("+x+"px,"+y+"px)";
  }

  function clearEntities(){ for (var i=0;i<entities.length;i++){ entities[i].el.remove(); } entities=[]; }

  function placePlayer(){
    if (player) player.el.remove();
    playerY = stage.clientHeight - ENTITY_SIZE - 20;
    player = makeEntity("player", lane, playerY);
  }

  function spawn(now){
    if (now - lastSpawn < spawnEvery) return;
    lastSpawn = now;
    var laneIndex = Math.floor(Math.random()*3);
    var type = Math.random()<0.7 ? "good":"bad";
    var e = makeEntity(type, laneIndex, -ENTITY_SIZE-10);
    entities.push(e);
    speed += 2;
    spawnEvery = Math.max(350, spawnEvery - 6);
  }

  function movePlayer(dir){
    var newLane = lane + dir;
    if (newLane<0 || newLane>2) return;
    lane = newLane;
    placePlayer();
  }

  function rectsOverlap(a,b){
    var ar=a.getBoundingClientRect(), br=b.getBoundingClientRect();
    return !(ar.right<br.left || ar.left>br.right || ar.bottom<br.top || ar.top>br.bottom);
  }

  function loop(ts){
    if (!running){ return; }
    if (!loop.last) loop.last = ts;
    var dt = (ts - loop.last)/1000; loop.last=ts;
    spawn(ts);
    for (var i=entities.length-1;i>=0;i--){
      var e=entities[i];
      e.y += speed*dt;
      positionEntity(e.el, e.lane, e.y);
      if (rectsOverlap(e.el, player.el)){
        if (e.type==="good"){
          score++; scoreEl.textContent=score;
          e.el.remove(); entities.splice(i,1);
        }else{ end(); return; }
      }else if (e.y > stage.clientHeight){
        if (e.type==="good"){ end(); return; }
        else { e.el.remove(); entities.splice(i,1); }
      }
    }
    requestAnimationFrame(loop);
  }

  var touchStartX=0, touchStartY=0;
  stage.addEventListener('touchstart', function(e){ var t=e.changedTouches[0]; touchStartX=t.clientX; touchStartY=t.clientY; }, {passive:true});
  stage.addEventListener('touchend', function(e){
    var t=e.changedTouches[0]; var dx=t.clientX-touchStartX; var dy=t.clientY-touchStartY;
    if (Math.abs(dx)>Math.abs(dy)){ if (dx>20) movePlayer(1); else if (dx<-20) movePlayer(-1); }
  }, {passive:true});
  window.addEventListener('keydown', function(e){ if (e.key==="ArrowLeft") movePlayer(-1); if (e.key==="ArrowRight") movePlayer(1); });

  function startTimer(){
    stopTimer(); timeLeft=60; timeEl.textContent=timeLeft; var t0=Date.now();
    timerId=setInterval(function(){
      var left=Math.max(0,60-Math.floor((Date.now()-t0)/1000));
      timeLeft=left; timeEl.textContent=left;
      if(left<=0){ stopTimer(); end(); }
    },200);
  }
  function stopTimer(){ if (timerId){ clearInterval(timerId); timerId=null; } }

  function awardStars(finalScore){
    var prev=getBest(); var stars=1;
    if(finalScore>prev){ stars=2; setBest(finalScore); }
    var total=addStars(stars);
    bestEl.textContent=getBest(); starsEl.textContent=total;
    return stars;
  }
  function end(){
    running=false; stopTimer();
    var s=score, stars=awardStars(s);
    mscore.textContent=s; mbest.textContent=getBest(); mstars.textContent=stars;
    modal.style.display="grid";
  }

  function start(){
    modal.style.display="none"; running=true; score=0; scoreEl.textContent=0; loop.last=0;
    speed=180; spawnEvery=900; lastSpawn=0; lane=1;
    clearEntities(); placePlayer(); sizeStage();
    startTimer(); requestAnimationFrame(loop);
  }

  document.getElementById('again').addEventListener('click', start);
  document.getElementById('close').addEventListener('click', function(){ modal.style.display="none"; });
  btnNew.addEventListener('click', start);
  safe.addEventListener('change', function(){
    if (player) player.el.textContent = safe.checked ? "P" : ICONS.player;
    for (var i=0;i<entities.length;i++){ entities[i].el.textContent = safe.checked ? (entities[i].type==="good"?"G":"X") : (entities[i].type==="good"?ICONS.good:ICONS.bad); }
  });

  start();
})();</script>
</body>
</html>
